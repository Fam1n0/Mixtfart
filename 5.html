<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Mixed Art</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.0/p5.js"></script>
<style>
  body { margin: 0; }
  #fileInput { display: block; margin: 10px; }
  #buttons { position: fixed; top: 50px; left: 10px; }
</style>
</head>
<body>
<input type="file" id="fileInput" accept="image/*" multiple>
<div id="buttons">
  <button onclick="startMix()">Mix</button>
  <button onclick="stopMix()">Stop</button>
</div>
<script>
  let images = [];
  let mixing = false;
  let commonWidth; // Width to which all images will be resized
  let commonHeight; // Height to which all images will be resized
  let progress = []; // Array to track drawing progress for each image

  function preload() {
    // Optionally, you can preload some images if you have their URLs
  }

  function setup() {
    createCanvas(windowWidth, windowHeight);
    noLoop(); // Stop the draw loop until images are loaded

    document.getElementById('fileInput').addEventListener('change', function(e) {
      const files = e.target.files;
      commonWidth = Infinity; // Start with a very large value
      commonHeight = Infinity; // Start with a very large value

      // First, determine the smallest dimensions
      let imageElements = [];
      Array.from(files).forEach((file, index) => {
        let img = createImg(URL.createObjectURL(file), () => {
          commonWidth = min(commonWidth, img.width);
          commonHeight = min(commonHeight, img.height);
          img.hide(); // Hide the image element
          imageElements.push(img);
          if (imageElements.length === files.length) {
            // Resize and load images
            imageElements.forEach(imgEl => {
              imgEl.size(commonWidth, commonHeight);
              images.push(imgEl);
              let rows = commonHeight / 5;
              let cols = commonWidth / 5;
              progress.push(new Array(rows).fill(0).map(() => new Array(cols).fill(false)));
            });
            loop(); // Start the draw loop when all images are loaded and resized
          }
        });
      });
    });
  }

  function draw() {
    if (mixing && images.length > 0) {
      let pieceWidth = 5;
      let pieceHeight = 5;

      // Pick a random image that is not yet completed
      let incompleteImages = images.filter((_, index) => progress[index].some(row => row.includes(false)));
      if (incompleteImages.length > 0) {
        let imgIndex = images.indexOf(random(incompleteImages));
        let img = images[imgIndex];
        
        // Find the next square that has not been drawn yet
        let drawn = false;
        while (!drawn) {
          let row = floor(random(img.height / pieceHeight));
          let col = floor(random(img.width / pieceWidth));
          
          if (!progress[imgIndex][row][col]) {
            let x = col * pieceWidth;
            let y = row * pieceHeight;
            img.loadPixels();
            let imgPiece = img.get(x, y, pieceWidth, pieceHeight);
            image(imgPiece, x, y);
            progress[imgIndex][row][col] = true; // Mark this square as drawn
            drawn = true;
          }
        }
      }
    }
  }

  function startMix() {
    if (images.length > 0) {
      mixing = true;
    }
  }

  function stopMix() {
    mixing = false;
  }
</script>
</body>
</html>
